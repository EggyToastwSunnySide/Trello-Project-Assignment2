<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ current_board_name }}</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #0079bf; margin: 0; padding: 0; color: #172b4d; display: flex; flex-direction: column; height: 100vh; }
        
        .navbar { background-color: rgba(0,0,0,0.25); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; color: white; flex-shrink: 0; backdrop-filter: blur(4px); }
        .nav-left { display: flex; align-items: center; gap: 10px; }
        
        .board-title-form input { background: transparent; border: none; color: white; font-size: 18px; font-weight: bold; width: 200px; cursor: pointer; }
        .board-title-form input:focus { background: white; color: black; outline: none; padding: 5px; cursor: text; border-radius: 3px; }
        
        .board-select { padding: 6px; border-radius: 3px; border: none; background-color: rgba(255,255,255,0.2); color: white; cursor: pointer; font-size: 14px; }
        .board-select option { color: #172b4d; background: white; }
        
        .btn-nav, .btn-del-board { background-color: rgba(255,255,255,0.2); color: white; text-decoration: none; padding: 6px 12px; border-radius: 3px; font-size: 14px; border: none; cursor: pointer; transition: background 0.2s; }
        .btn-nav:hover { background-color: rgba(255,255,255,0.3); }
        .btn-del-board:hover { background-color: #c00; }

        .board-stats { background: rgba(0,0,0,0.15); padding: 10px 20px; color: white; display: flex; align-items: center; gap: 15px; }
        .main-progress-bar { width: 300px; height: 10px; background: rgba(255,255,255,0.3); border-radius: 5px; overflow: hidden; }
        .main-progress-fill { height: 100%; background: #61bd4f; transition: width 0.5s; }

        .flash-container { padding: 10px 20px 0; }
        .alert { padding: 10px; border-radius: 4px; display:flex; justify-content:space-between; margin-bottom: 5px; font-size: 14px; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; font-weight: bold; }

        /* Board Container - SWITCHED TO CSS COLUMNS (MASONRY) */
        .board-container { 
            display: block; /* Required for columns */
            column-width: 300px; /* Creates responsive newspaper-style columns */
            column-gap: 20px; /* Space between columns */
            column-fill: auto; /* Fills columns sequentially to keep order better */
            overflow-y: auto; 
            padding: 20px; 
            flex: 1; 
            box-sizing: border-box;
        }
        
        /* List Styles - MODIFIED TO PREVENT BREAKING */
        .list { 
            background-color: #ebecf0; 
            border-radius: 3px; 
            width: 100%; /* Fit the column width */
            margin-bottom: 20px; /* Space at bottom of each item */
            padding: 10px; 
            display: inline-block; /* Critical: Prevents list from splitting across columns */
            break-inside: avoid; /* Webkit support */
            box-sizing: border-box;
            vertical-align: top;
        }
        
        .list-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 8px; font-weight: bold; color: #172b4d; }
        .list-title-form input { background: transparent; border: none; font-weight: bold; font-size: 14px; color: #172b4d; width: 180px; }
        .list-title-form input:focus { background: white; outline: 2px solid #0079bf; padding: 2px; }
        
        .list-actions { display: flex; gap: 5px; }
        .btn-list-action { background: none; border: none; color: #6b778c; cursor: pointer; font-size: 14px; }
        .btn-list-action:hover { color: #172b4d; }
        .btn-list-del:hover { color: red; }

        .cards-container { min-height: 10px; padding-right: 0; }

        .card { background: white; border-radius: 3px; padding: 8px 10px; margin-bottom: 8px; box-shadow: 0 1px 0 rgba(9,30,66,.25); cursor: pointer; position: relative; }
        .card:hover { background: #f4f5f7; }
        .completed-card { background-color: #f8f9fa; opacity: 0.7; }
        .completed-card .card-title { text-decoration: line-through; color: #6c757d; }
        
        .card-actions { position: absolute; top: 4px; right: 4px; display: none; gap: 4px; }
        .card:hover .card-actions { display: flex; }
        .icon-btn { background: rgba(255, 255, 255, 0.8); border: none; color: #6b778c; cursor: pointer; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; border-radius: 3px; text-decoration: none; font-size: 12px; }
        .icon-btn:hover { background: #ebecf0; color: #172b4d; }
        .btn-del:hover { color: #c00; background: #ffebeb; }

        .card-title { font-weight: 500; padding-right: 45px; word-wrap: break-word; }
        .badges { margin-top: 6px; display: flex; gap: 5px; font-size: 11px; font-weight: 600; }
        .badge { padding: 2px 6px; border-radius: 3px; color: white; }
        .priority-Urgent { background: #eb5a46; } .priority-High { background: #ff9f1a; }
        .priority-Medium { background: #f2d600; color: #333; } .priority-Low { background: #61bd4f; }
        
        .meta { color: #5e6c84; font-size: 12px; margin-top: 8px; }
        
        .add-list-panel { background: rgba(255,255,255,0.2); border-radius: 3px; width: 100%; padding: 10px; display: inline-block; box-sizing: border-box; }
        .add-list-panel input { width: 100%; padding: 8px; border-radius: 3px; border: none; margin-bottom: 5px; box-sizing: border-box; }
        .add-list-panel button { background: #5ba4cf; color: white; border: none; padding: 8px 12px; border-radius: 3px; cursor: pointer; font-weight: bold; }
        .add-list-panel button:hover { background: #026aa7; }

        .add-card-link { color: #5e6c84; padding: 8px; margin-top: 5px; border-radius: 3px; cursor: pointer; text-decoration: none; display: block; }
        .add-card-link:hover { background: rgba(9,30,66,.08); color: #172b4d; }
        
        .fab-btn { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: #0079bf; color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; text-decoration: none; font-size: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 1000; transition: transform 0.2s; }
        .fab-btn:hover { transform: scale(1.1); background: #026aa7; }

        .last-modified {
            font-size: 10px;
            color: #97a0af;
            margin-top: 6px;
            padding-top: 4px;
            border-top: 1px solid #eee;
            font-style: italic;
        }
    </style>
</head>
<body>

    <!-- NAVBAR -->
    <div class="navbar">
        <div class="nav-left">
            <form action="/edit_board/{{ current_board_id }}" method="POST" class="board-title-form">
                <input type="text" name="name" value="{{ current_board_name }}" onchange="this.form.submit()" title="Click to rename board">
            </form>

            <select class="board-select" onchange="location = this.value;">
                {% for board in all_boards %}
                    <option value="/?board_id={{ board.BoardID }}" {% if board.BoardID == current_board_id %}selected{% endif %}>{{ board.Name }}</option>
                {% endfor %}
            </select>
            
            <form action="/delete_board/{{ current_board_id }}" method="POST" onsubmit="return confirm('Delete this board?');">
                <button type="submit" class="btn-del-board" title="Delete current board">ðŸ—‘</button>
            </form>

            <a href="/create_board" class="btn-nav">+ New Board</a>
        </div>
        
        <div>
            {% if user_name %}<span style="font-size:14px; margin-right:15px;">ðŸ‘‹ {{ user_name }}</span>{% endif %}
            <a href="/logout" class="btn-nav" style="background:rgba(0,0,0,0.2);">Logout</a>
        </div>
    </div>

    <!-- GLOBAL BOARD PROGRESS BAR -->
    <div class="board-stats">
        <div style="font-size: 14px; font-weight: bold;">Board Completion: {{ board_progress }}%</div>
        <div class="main-progress-bar">
            <div class="main-progress-fill" style="width: {{ board_progress }}%;"></div>
        </div>
    </div>

    <!-- FLASH MESSAGES -->
    <div class="flash-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }}"><span>{{ message }}</span><span onclick="this.parentElement.style.display='none'" style="cursor:pointer;">Ã—</span></div>
            {% endfor %}
          {% endif %}
        {% endwith %}
    </div>

    <!-- MAIN BOARD -->
    <div class="board-container">
        
        {% for list_info, cards in lists.items() %}
        <div class="list">
            <div class="list-header">
                <form action="/edit_list/{{ list_info[0] }}" method="POST" class="list-title-form">
                    <input type="hidden" name="board_id" value="{{ current_board_id }}">
                    <input type="text" name="title" value="{{ list_info[1] }}" onchange="this.form.submit()">
                </form>
                
                <div class="list-actions">
                    <form action="/delete_list/{{ list_info[0] }}?board_id={{ current_board_id }}" method="POST" onsubmit="return confirm('Delete list?');">
                        <button type="submit" class="btn-list-action btn-list-del">ðŸ—‘</button>
                    </form>
                </div>
            </div>

            <div class="cards-container">
                {% for card in cards %}
                <div class="card {% if card.is_completed %}completed-card{% endif %}">
                    <div class="card-actions">
                        <a href="/edit_card/{{ card.id }}" class="icon-btn">âœŽ</a>
                        <form action="/delete_card/{{ card.id }}?board_id={{ current_board_id }}" method="POST" onsubmit="return confirm('Delete?');" style="margin:0;">
                            <button type="submit" class="icon-btn btn-del">Ã—</button>
                        </form>
                    </div>
                    <div class="card-title">{% if card.is_completed %}âœ“ {% endif %}{{ card.title }}</div>
                    <div class="badges"><span class="badge priority-{{ card.priority }}">{{ card.priority }}</span></div>
                    <div class="meta">
                        {% if card.due_date %}<span>ðŸ“… {{ card.due_date }}</span>{% endif %}
                        <span>ðŸ‘¤ {{ card.assignees }}</span>
                    </div>

                    <!-- Display Last Modified User and Time -->
                    {% if card.mod_user %}
                    <div class="last-modified">
                        Edited by {{ card.mod_user }} at {{ card.mod_time }}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            
            {% if list_info[1] not in ['Completed', 'Done', 'Finished'] %}
                <a href="/add?board_id={{ current_board_id }}" class="add-card-link">+ Add a card</a>
            {% endif %}
        </div>
        {% endfor %}

        <div class="add-list-panel">
            <form action="/create_list" method="POST">
                <input type="hidden" name="board_id" value="{{ current_board_id }}">
                <input type="text" name="title" placeholder="+ Add another list" required>
                <button type="submit">Add List</button>
            </form>
        </div>

    </div>
    
    <a href="/add?board_id={{ current_board_id }}" class="fab-btn" title="Add New Card">+</a>
</body>
</html>